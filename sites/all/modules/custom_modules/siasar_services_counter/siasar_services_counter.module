<?php
/**
 * Implementation of hook_services_resources().
 */
function siasar_services_counter_services_resources() {
  return array(
    'entity_count' => array(
      'operations' => array(
        'index' => array(
          'help' => 'Retrieves total number of entities saved, by type. Parameters: entity type, bundle.',
          'callback' => '_siasar_services_counter_entity_count',
          'args' => array(
            array(
              'name' => 'entity_name',
              'type' => 'string',
              'description' => '',
              'source' => array('path' => 0),
              'optional' => FALSE,
            ),
            array(
              'name' => 'bundle',
              'type' => 'string',
              'description' => '',
              'source' => array('path' => 1),
              'optional' => TRUE,
            )
          ),
          'access arguments' => array('access content'),
        ),
      ),
    ),
  );
}

/**
 * Callback for 'entity_count' endpoint.
 * Delivers number of saved entities by type and bundle.
 *
 * @param string $entity_name
 *   Entity name. Required.
 *
 * @param string $bundle
 *   Entity bundle.
 *
 * @return array
 *   Keyed array [bundle_machine_name] => int
 */
function _siasar_services_counter_entity_count($entity_name, $bundle) {
  $bundles = $bundle
    ? array($bundle)
    : array_keys(entity_get_info($entity_name)['bundles']);

  foreach ($bundles as $b) {
    $total[$b] = _siasar_services_counter_get_totals_per_bundle($entity_name, $b);
  }

  return $total;
}

/**
 * Helper funtion. Counts all existing entities of a given class, by bundle.
 *
 * @param string $entity_name
 *   Entity machine name
 *
 * @param array $bundles
 *   Bundles machine names
 *
 * @return array
 *   Keyed array [entityform_machine_name] => int
 */
function _siasar_services_counter_get_totals_per_bundle($entity_name, $bundle) {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', $entity_name)
    ->entityCondition('bundle', $bundle)
    ->count();
  return $query->execute();
}
