<?php

/**
 * Alter results on the Entityform services call.
 *
 * @param $controller
 *   Controller definition
 * @param array $args
 *   Arguments passed to services callback
 * @param array $result
 *   Array of results that can be altered
 *
 * @see services_controller_execute()
 * @see services.runtime.inc
 */
function siasar_services_entityform_alter_services_request_postprocess_alter($controller, $args, &$result) {

  if (arg(1) == 'entity_entityform') { // At this moment, only field collection structure is considered for changes.

    if (arg(2) == null && is_array($result)) {
      foreach ($result as &$response) {
        $response = _siasar_services_entityform_alter_get_referenced_entityform_name($response);
      }
    } elseif (arg(2) !== null && is_array($result[$args[0]])) {
      //$result = _siasar_services_entityform_alter_get_referenced_entityform_name($result[$args[0]]);
    }
  }
}

/**
 * Gets entity name where a entityform is being referenced and this entity has a "field_entity_name" value set.
 * It traverses all fields on the Field Collection.
 *
 * @param array $data
 *   Array of results that can be altered
 */
function _siasar_services_entityform_alter_get_referenced_entityform_name($data) {

  if (!is_array($data)) return $data;

  foreach ($data as &$field) {
    if (!is_array($field) || empty($field)) {
      continue;
    }
    elseif (_siasar_array_is_numeric($field)) {
      // Evaluate for Sequential array
      $field = _siasar_services_entityform_alter_get_referenced_entityform_name($field);
      continue;
    }
    elseif (isset($field['resource'])) {
      switch($field['resource']) {
        case 'taxonomy_term':
          $field = _siasar_services_entityform_alter_attach_term_info($field);
          break;
      }
    }
  }
  return $data;
}

/**
 * Gets taxonomy term and adds loaded info to $field array
 * Adapted from http://stackoverflow.com/a/5969617/381914
 *
 * @param array $data
 *   Array of results that can be altered
 */
function _siasar_services_entityform_alter_attach_term_info($field) {
  if (!isset($field['id'])) return $field;

  $term = taxonomy_term_load($field['id']);
  $field['name'] = $term->name;
  $field['tid'] = $term->tid;
  unset ($field['id']);

  return $field;
}

/**
 * Checks if all array keys are numeric
 *
 * @param array $data
 *   Array of results that can be altered
 * @return bool
 *   True if all array keys are numeric, false otherwise
 */
function _siasar_array_is_numeric(array $array) {
  for (reset($array); is_int(key($array)); next($array));
  $is_numeric = is_null(key($array));

  return $is_numeric;
}


