<?php

/**
* Implements of hook_services_resources().
*/
function taxonomy_web_service_services_resources() {
 $api = array(
    'vocab' => array(
      'operations' => array(
        'index' => array(
          'help' => 'List hierarchical taxonomy information.',
          'callback' => '_taxonomy_vocab_service_index',
          'access callback' => 'user_access',
          'access arguments' => array('access content'),
          'access arguments append' => FALSE,
          'args' => array(
            array(
              'name' => 'vocab_name',
              'type' => 'string',
              'description' => 'Name of the Vocabulary',
              'source' => array('path' => '0'),
              'optional' => TRUE,
              'default' => '0',
            ),
          ),
        ),
      ),
    ),
  );
  return $api;
}

function _taxonomy_vocab_service_index($vocab_name) {
	$country_code = get_country_code();
  $settings = array();
  if($vocabulary = taxonomy_vocabulary_machine_name_load($vocab_name)){
     $options = array();
     if($terms = taxonomy_get_tree($vocabulary->vid, 0, 1)){     
      foreach ($terms as $term) {
        if(is_valid_term($term, $country_code)) {
          $options[$term->tid] = $term->name;
        }
      }
    }
    $hierarchy = array();
    if(read_children($vocabulary, $options, $hierarchy)){					
      $settings['hierarchy'] = $hierarchy;
    }
    $settings['allowed_values'] = $options;
  }  
	return $settings;
}